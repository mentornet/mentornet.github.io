<html>
	<head>
		<!-- <HEAD> TEMPLATE -->
		<!-- Meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

		<!-- CSS tags. nb: files relative to ./nav-redesign, not ./ -->
    <link href="./vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./vendor/font-awesome/css/font-awesome.min.css">
		<style>
			a:hover {
				text-decoration: none;
			}
		</style>

		<!-- END TEMPLATE -->

		<title>Mentor Net - Sign Up</title>
	</head>
	<body>

		<div style="width: 20em; margin-top: 27vh;" class="container">

			<div class="row align-items-center justify-content-between">
				<div class="col-6 text-left">
					<a href="index.html" class="text-dark">
						<h4 class="mb-0">Mentor Net</h4>
					</a>
				</div>
				<div class="col-6 text-right">
					<h4 class="mb-0 text-muted">Sign Up</h4>
				</div>
			</div>

			<!-- User pre-auth / log in / sign up mechanism: vue entry -->
			<div id="vue-entry"
				style="display: none" v-show="true"
				class="text-center py-3">

					<div class="py-2 w-100 bg-danger text-light" v-show="errorMessage.length">
						<p class="text-center m-0">Error: {{ errorMessage }}</p>
					</div>

					<form
						action="javascript:void(0)"
						@submit="setState(uiStates.contactDetails)"
						v-show="uiState === uiStates.loginDetails">
						<input
							v-model="email"
							@input="(ev) => isEmailInvalid = !ev.target.checkValidity()"

							class="form-control"
							type="email"
							autocomplete="off"
							placeholder="example@email.com"
							required/>
						<input
							v-model="passwd"
							class="form-control mt-3"
							type="password"
							autocomplete="off"
							placeholder="Password"
							required/>
						<small>You'll use these to log in.</small>

						<div class="mt-3">
							<button
								type="submit"
								class="btn btn-primary w-100"
								:disabled="isEmailInvalid || !passwd.length"
								>Next</button>
						</div>
					</form>

					<form
						action="javascript:void(0)"
						@submit="setState(uiStates.mentorSwitch)"
						v-show="uiState === uiStates.contactDetails">
						<input
							v-model="name"
							class="form-control"
							type="text"
							autocomplete="off"
							placeholder="Your Name"
							required/>
						<small>Other users will see you by your name.</small>

						<input
							v-model="phone"
							class="form-control mt-3"
							type="tel"
							autocomplete="off"
							placeholder="04XXXXXXXX"
							/>
						<small>You don't have to, but if you give us your phone number we can contact you easier.</small>

						<div class="row mt-3">
							<div class="col">
								<button
									type="button"
									class="btn btn-secondary w-100"
									@click="setState(uiStates.loginDetails)">Back</button>
							</div>
							<div class="col">
								<button
									class="btn btn-primary w-100"
									:disabled="!name.length"
									type="submit">Next</button>
								</div>
							</div>
					</form>

					<div v-show="uiState === uiStates.mentorSwitch">
						<p>Do you want to be a mentor?</p>

						<div class="row">
							<div class="col">
								<button
									class="btn btn-secondary w-100"
									@click="setState(uiStates.contactDetails)">Back</button>
							</div>
							<div class="col">
								<button
									class="btn btn-primary w-100"
									@click="setState(uiStates.studentFinish)">No</button>
							</div>
							<div class="col">
								<button
									class="btn btn-primary w-100"
									@click="setState(uiStates.mentorSkills)">Yes</button>
							</div>
						</div>
					</div>

					<div v-show="uiState === uiStates.studentFinish">
						<p>Then you're all set! Check your info to make sure it's right:</p>
						<!-- TODO -->
						<p> { student sign up info } </p>
						<div class="row">
							<div class="col">
								<button 
									class="btn btn-secondary w-100"
									@click="setState(uiStates.mentorSwitch)">Back</button>
							</div>
							<div class="col">
								<button
									class="btn btn-primary w-100"
									@click="">Get started</button>
							</div>
						</div>
					</div>

					<div v-show="uiState === uiStates.mentorSkills">
						<p class="mb-3 py-1" v-if="skills.length === 0">What can you mentor?</p>
						<form action="javascript:void(0);" @submit="addSkill" class="text-left">
							<span
								style="display: none"
								v-for="(skill, index) in skills"
								v-show="1"
								class="text-light btn btn-sm btn-dark mx-1 mb-3"
								:key="index"
								:index="index"
								:skill="skill"
								@click="deleteSkill(index)">

								<span class="py-1">
									{{ skill.slice(0,1).toUpperCase() + skill.slice(1) }}
									<i class="ml-1 fa fa-close"></i>
								</span>
							
							</span>
							<input
								ref="skillInput"
								@input="(ev) => validateSkillInput(ev.target)"
								class="form-control"
								type="text"
								required
								placeholder="Skill (e.g.: APA 6 referencing)" />
							<button
								type="submit"
								class="btn btn-outline-info w-100 mt-3">Add Skill</button>
						</form>
						<div class="row">
							<div class="col">
								<button 
									class="btn btn-secondary w-100"
									@click="setState(uiStates.mentorSwitch)">Back</button>
							</div>
							<div class="col">
								<button
									class="btn btn-primary w-100"
									:disabled="!skills.length"
									@click="setState(uiStates.mentorPayment1)">Next</button>
							</div>
						</div>
					</div>

					<div v-show="uiState === uiStates.mentorPayment1">
						<p>How would you like to get paid?</p>

						<div class="row">
							<div class="col-4">
								<button 
									class="btn btn-secondary w-100"
									@click="setState(uiStates.mentorSkills)">Back</button>
							</div>
							<div class="col-8">
								<button
									class="btn btn-outline-primary w-100"
									@click="setState(uiStates.mentorPayment2A)">BSB & Account No.</button>
							</div>
							<div class="col-12 mt-3">
								<button
									:class="nextButtonClass"
									@click="setState(uiStates.mentorPayment2B)">PayID</button>
							</div>
						</div>
					</div>

					<div v-show="uiState === uiStates.mentorPayment2A">
						<input
							v-model="bsb"
							class="form-control"
							type="tel"
							autocomplete="off"
							placeholder="BSB"
							required/>
						<input
							v-model="accountNumber"
							class="form-control mt-3"
							type="tel"
							autocomplete="off"
							placeholder="Account No."
							required/>

						<div class="row mt-3">
							<div class="col">
								<button 
									class="btn btn-secondary w-100"
									@click="setState(uiStates.mentorPayment1)">Back</button>
							</div>
							<div class="col">
								<button
									class="btn btn-primary w-100"
									:disabled="!bsbValid || !accountNumberValid"
									@click="setState(uiStates.mentorFinish)">Done</button>
							</div>
						</div>
					</div>

					<div v-show="uiState === uiStates.mentorPayment2B">
						<input
							v-model="payid"
							class="form-control"
							type="text"
							autocomplete="off"
							placeholder="PayID"
							required/>

						<div class="row mt-3">
							<div class="col">
								<button 
									class="btn btn-secondary w-100"
									@click="setState(uiStates.mentorPayment1)">Back</button>
							</div>
							<div class="col">
								<button
									class="btn btn-primary w-100"
									:disabled="!payid.length"
									@click="setState(uiStates.mentorFinish)">Done</button>
							</div>
						</div>
					</div>

					<div v-show="uiState === uiStates.mentorFinish">
						<p>All set! Check your info to make sure it's right:</p>
						<!-- TODO -->
						<p> { mentor sign up info } </p>
						<div class="row">
							<div class="col">
								<button 
									:class="prevButtonClass"
									@click="setState(uiStates.mentorPayment1)">Back</button>
							</div>
							<div class="col">
								<button
									:class="nextButtonClass"
									@click="">Get started</button>
							</div>
						</div>
					</div>
			</div>
		</div>

		<!-- Javascript (global) -->
		<script src="https://cdn.jsdelivr.net/npm/vue"></script>
		<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
		<script src="./js/generics.js"></script>
		<script src="./js/session-data.js"></script>

		<!-- Javascript (local) -->
		<script>
			let vue = new Vue({
				el: '#vue-entry',
				data: {
					email: '',
					passwd: '',

					name: '',
					phone: '',

					skills: [],

					payid: '',
					bsb: '',
					accountNumber: '',

					errorMessage: '',
					uiState: 0,

					uiStates: {
						loginDetails: 0,
						contactDetails: 1,

						mentorSwitch: 2,

						studentFinish: 3,

						mentorSkills: 4,
						mentorPayment1: 5,
						mentorPayment2A: 6,
						mentorPayment2B: 7,
						mentorFinish: 8
					},

					nextButtonClass: 'btn btn-primary w-100 ',
					prevButtonClass: 'btn btn-secondary w-100 ',

					isEmailInvalid: true
				},
				computed: {
					bsbValid () {
						return this.bsb.length === 6 && Number.isNaN(Number(this.bsb)) === false;
					},
					accountNumberValid () {
						return this.accountNumber.length && Number.isNaN(Number(this.accountNumber)) === false;
					}
				},
				methods: {
					setState(state) {
						this.uiState = state;
					},
					addSkill () {
						let skillInput = this.$refs.skillInput;
						if (this.validateSkillInput(skillInput)) {
							this.skills = this.skills.concat(skillInput.value);
							skillInput.value = '';
						}
					},
					validateSkillInput (el) {
						const isValid = !this.skills.includes(el.value);
						const validMessage = '', invalidMessage = 'Skill already given';
						el.setCustomValidity(isValid ? validMessage : invalidMessage);
						return isValid;
					},
					deleteSkill (skillIndex) {
						let tmpArr = this.skills.concat();
						tmpArr.splice(skillIndex, 1);
						this.skills = tmpArr;
						this.validateSkillInput( this.$refs.skillInput );
					},
					signup () {
						this.setErrorMessage('');

						const ajaxPackage = {
							payid: this.payid,
							passwd: this.passwd,
							name: this.name,
							phone: this.phone.split('').filter(c => c !== ' ').join('')
						};

						http.post('/user', ajaxPackage)
							.then(response => {
								buildSessionData(response.data);
								authRedirect();
							})
							.catch(handleAxiosError)
							.then(this.setErrorMessage);
					},
					setErrorMessage(msg) {
						this.errorMessage = msg;
					}
				}
			});

			function authRedirect () {
				redirect('mentor-list.html');
			}
		</script>
	</body>
</html>
