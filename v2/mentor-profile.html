<!DOCTYPE html>
<html>
	<head>
		<!-- <HEAD> TEMPLATE -->
		<!-- Meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

		<!-- CSS tags. nb: files relative to ./nav-redesign, not ./ -->
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
    <link rel="stylesheet" href="./vendor/font-awesome/css/font-awesome.min.css">

		<!-- END TEMPLATE -->

		<title>Mentor Net</title>
	</head>
	<body id="top">

		<header class="container pt-2 pb-0 bg-dark text-light">
			<h4 class="row mb-0">
				<a href="requests.html" class="col-6 px-2 text-light">Mentor Net</a>
				<small class="text-right col px-2 mt-1">Your Profile</small>
			</h4>
		</header>

		<nav class="container pt-2 pb-2 bg-dark">
			<div class="row">
				<div class="col-6 px-2">
					<a href="requests.html" class="btn btn-sm btn-outline-warning w-100">
						<i class="fa fa-fw fa-list"></i> Teach
					</a>
				</div>
				<div class="col-6 px-2">
					<span class="btn btn-sm btn-warning w-100">
						<i class="fa fa-fw fa-user"></i> Profile
					</span>
				</div>
			</div>
		</nav>

		<div id="vue-entry" class="container" style="display: none" v-show="1">

			<div class="py-2" v-if="comingSessions.length">
				<small class="text-muted border-bottom" id="sessions">COMING SESSIONS</small>

				<a href="#" class="row pt-2" v-for="session in comingSessions">
					<div class="col-3"> {{ session.date }} </div>
					<div class="col-9 text-right"> {{ session.mentorName }} </div>
				</a>

			</div>

			<div class="py-2" v-if="pastSessions.length">
				<small class="text-muted border-bottom" id="sessions">PAST SESSIONS</small>

				<a href="#" class="row pt-2" v-for="session in pastSessions">
					<div class="col-3"> {{ session.date }} </div>
					<div class="col-9 text-right"> {{ session.mentorName }} </div>
				</a>

			</div>

			<div id="settings">
				<div class="py-2">
					<div class="row">
						<div class="col-6" style="height: 26px !important;">
							<small class="text-muted border-bottom">PROFILE SETTINGS</small>
						</div>
						<div class="col-3 px-2" v-show="hasChanges">
							<button
								:disabled="ajaxLoading"
								@click="saveChanges()" class="btn btn-sm btn-outline-success py-0 w-100">

								<i class="fa fa-fw fa-check" v-show="!ajaxLoading"></i> 
								<i class="fa fa-fw fa-pulse fa-spinner" v-show="ajaxLoading"></i> 

							</button>
						</div>
						<div class="col-3 px-2" v-show="hasChanges">
							<button
								:disabled="ajaxLoading"
								@click="discardChanges()" class="btn btn-sm btn-outline-danger py-0 w-100">
								<i class="fa fa-fw fa-times"></i> 
							</button>
						</div>
					</div>

					<div class="row pt-2" v-show="errorMessage.length > 0">
						<p class="small mb-0 text-center col-12 py-2 bg-danger text-light">
							{{ errorMessage }}
						</p>
					</div>

					<div class="row pt-2">
						<div class="col-3 d-flex flex-column align-items-start justify-content-center">
							Email
						</div>
						<div class="col-9 input-group">
							<input type="text" class="form-control form-control-sm"
								:disabled="ajaxLoading"
								v-model="editedProfile.email" />
						</div>
					</div>

					<div class="row pt-2">
						<div class="col-3 d-flex flex-column align-items-start justify-content-center">
							Name
						</div>
						<div class="col-9 input-group">
							<input type="text" class="form-control form-control-sm"
								:disabled="ajaxLoading"
								v-model="editedProfile.name" />
						</div>
					</div>

					<div class="row pt-2">
						<div class="col-3 d-flex flex-column align-items-start justify-content-center">
							Ph No.
						</div>
						<div class="col-9 input-group">
							<input type="text" class="form-control form-control-sm"
								:disabled="ajaxLoading"
								v-model="editedProfile.phone" />
						</div>
					</div>

					<div class="row pt-2">

						<div class="col-3 pt-1">
							Skills
						</div>

						<form action="javascript:void(0);" @submit="addSkill" class="col-9 text-right">

							<div class="input-group">
								<input
									:disabled="ajaxLoading"
									ref="skillInput"
									@input="(ev) => validateSkillInput(ev.target)"
									class="form-control form-control-sm"
									type="text"
									required
									placeholder="Enter a skill" />

								<button
									:disabled="ajaxLoading"
									type="submit"
									class="ml-1 btn btn-sm btn-outline-warning">
									<i class="fa fa-plus"></i>
								</button>
							</div>

							<span
								v-for="(skill, index) in editedProfile.skills"
								class="text-light btn btn-sm btn-dark ml-1 mt-2"
								:key="index"
								:index="index"
								:skill="skill"
								@click="deleteSkill(index)">

								<span class="py-1">
									{{ skill.slice(0,1).toUpperCase() + skill.slice(1) }}
									<i class="ml-1 fa fa-close"></i>
								</span>
							
							</span>
						</form>
					</div>

					<div>

						<div class="row pt-2">
							<div class="col-3 d-flex flex-column align-items-start justify-content-center">Rate</div>
							<div class="col-9 input-group">
								<div class="input-group-prepend">
									<span class="input-group-text">$</span>
								</div>
								<!-- TODO: Configure this input for validating cash amounts only -->
								<input type="text" class="form-control form-control-sm text-center"
									:disabled="ajaxLoading"
									v-model="editedProfile.rate" />
								<div class="input-group-append">
									<span class="input-group-text">/ hour</span>
								</div>
							</div>
						</div>

						<div class="row pt-2" v-if="hasPayID">
							<div class="col-3 d-flex flex-column align-items-start justify-content-center">PayID</div>
							<div class="col-9 input-group">
								<input type="text" class="form-control form-control-sm"
									:disabled="ajaxLoading"
									v-model="editedProfile.payid" />
							</div>
						</div>
						<div v-if="!hasPayID">
							<div class="row pt-2">
								<div class="col-3 d-flex flex-column align-items-start justify-content-center">BSB</div>
								<div class="col-9 input-group">
									<!-- TODO: configure to only allow valid BSBs -->
									<input type="text" class="form-control form-control-sm"
										:disabled="ajaxLoading"
										v-model="editedProfile.bsb" />
								</div>
							</div>
							<div class="row pt-2">
								<div class="col-4 d-flex flex-column align-items-start justify-content-center">Acc No.</div>
								<div class="col-8 input-group">
									<!-- TODO: configure to only allow valid account numbers -->
									<input type="text" class="form-control form-control-sm"
										:disabled="ajaxLoading"
										v-model="editedProfile.accountNumber" />
								</div>
							</div>
						</div>

					</div>

				</div>

			</div>

		</div>

		<!-- Javascript (global) -->
		<script src="https://cdn.jsdelivr.net/npm/vue"></script>
		<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
		<script src="./js/generics.js"></script>
		<script src="./js/session-data.js"></script>

		<!-- Javascript (local) -->
		<script>
			const copy = (obj) => Object.assign({}, obj);
			const initialUserData = sessionManager.getDataSubset(
					'uid', 'email', 'name', 'phone', 'rate', 'payid', 'bsb', 'accountNumber', 'skills'
			);

			let pageData = {
				comingSessions: [],
				pastSessions: [],

				profile: initialUserData,
				editedProfile: copy(initialUserData),

				ajaxLoading: false,
				errorMessage: ''
			};

			let vue = new Vue({
				el: '#vue-entry',
				data: pageData,
				computed: {
					hasSessions () {
						return this.comingSessions.length || this.pastSessions.length;
					},
					hasChanges () {
						const profileValues = Object.values(this.profile);
						const editedValues  = Object.values(this.editedProfile);
						const equivalentValues = profileValues.map((x, i) => x === editedValues[i]);
						const allEquivalent = equivalentValues.reduce((a,b) => a && b, true);
						return !allEquivalent;
					},
					hasPayID () {
						return this.profile.payid && this.profile.payid.length > 0 || false;
					}
				},
				methods: {
					saveChanges () {
						this.ajaxLoading = true;

						const ajaxPackage = this.editedProfile;

						http.put('/user', ajaxPackage)
							.then(response => {
								sessionManager.setDataFromModel(response.data);
								this.profile = response.data;
								this.editedProfile = copy(response.data);
								this.ajaxLoading = false;
							})
							.catch(error => {
								handleAxiosError(error);
								this.showError('Server error: ' + error);
								this.ajaxLoading = false;
								this.discardChanges();
							})
					},
					discardChanges () {
						this.editedProfile = copy(this.profile);
					},

					addSkill () {
						let skillInput = this.$refs.skillInput;
						if (this.validateSkillInput(skillInput)) {
							this.editedProfile.skills = this.editedProfile.skills.concat(skillInput.value);
							skillInput.value = '';
						}
					},
					validateSkillInput (el) {
						const isValid = !this.editedProfile.skills.includes(el.value);
						const validMessage = '', invalidMessage = 'Skill already given';
						el.setCustomValidity(isValid ? validMessage : invalidMessage);
						return isValid;
					},
					deleteSkill (skillIndex) {
						let tmpArr = this.editedProfile.skills.concat();
						tmpArr.splice(skillIndex, 1);
						
						if (tmpArr.length === 0) {
							// No dice, at least 1 skill to me a mentor
							this.showError('You need at least one skill! Add another first.');
							return;
						}

						this.editedProfile.skills = tmpArr;
						this.validateSkillInput( this.$refs.skillInput );
					},
					showError (errorMessage) {
						this.errorMessage = errorMessage;
						setTimeout(() => this.errorMessage = '', 5000);
					}
				},
				mounted () {
					if (!sessionManager.hasData())
						redirect('login.html');
				}
			});
		</script>

	</body>
</html>
