<html>
	<head>
		<!-- <HEAD> TEMPLATE -->
		<!-- Meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

		<!-- CSS tags. nb: files relative to ./nav-redesign, not ./ -->
    <link href="./vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./vendor/font-awesome/css/font-awesome.min.css">
		<style>
			a:hover {
				text-decoration: none;
			}
		</style>

		<!-- END TEMPLATE -->

		<title>Mentor Net - Session Notes</title>
	</head>
	<body class="text-center">

		<!-- Page Title -->
		<header class="container mt-3 mb-3">
			<h4 class="row">
				<span class="col-6">Mentor Net</span>
				<small class="text-muted col mt-1">Session Notes</small>
			</h4>
		</header>

		<!-- Vue Entry -->
		<div id="vue-entry">
			<div v-if="ajaxLoaded">
			<!-- Session timing, options to request extension, finish (shorten session) -->
			<!--
				The reason we won't consider a cancel button is that finishing an agreed upon session
				is equivalent to cancelling. More to the point if a mentor opts to finish before some
				preset grace period (e.g.: first 5 minutes of a session) then the user is fully
				refunded. -->
			<div class="container row">
				<div class="col-8 px-1">
					<h4 class="lead"> {{ buildElapsedTime(elapsedTime) }} <small class="text-muted"> / {{ buildElapsedTime(agreedTime*60*1000) }} </small></span>
				</div>
				<div class="col px-1">
				<button class="w-100 btn btn-sm btn-primary" @click="finishSession">Finish</button>
				</div>
			</div>

			<!-- Student info (e.g.: name, contact info, what we're teaching them) -->
			<div class="py-3">
				<small class="text-muted">
					Tutoring
					<a href="#" class="text-info">{{ studentName }}</a>
				</small>
			</div>

			<!-- Written notes -->
			<div>
				<textarea
					v-model="notesText"
					class="form-control"
					rows=6
					placeholder="Write some notes for your student here"></textarea>
			</div>

		</div>
		<div v-else style="height: 241px;">
			<p style="height: 100px; margin-bottom: 0;"></p>
			<p style="height: 120px">
				<span v-if="errorMessage" class="text-danger">
					Error: {{errorMessage}}
					<br>
					Click <a href="mentor-list.html" class="text-info">here</a> to continue.
				</span>
				<i v-else class="fa fa-spinner fa-pulse fa-2x"></i>
			</p>
		</div>
		</div>

		<!-- Footer -->
		<footer class="mt-1">
			<p class="mt-0 text-muted">Got a question? Get in touch:</p>
			<h4 class="row mx-auto w-50">
				<a href="mailto:tom@joinmentornet.me" class="col">
					<i class="fa fa-envelope"></i>
					<p class="h6 mt-2">Email</p>
				</a>

				<a href="tel:0450797678" class="col">
					<i class="fa fa-phone"></i>
					<p class="h6 mt-2">Phone</p>
				</a>
			</h4>
		</footer>

		<!-- Javascript (global) -->
		<script src="https://cdn.jsdelivr.net/npm/vue"></script>
		<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

		<script src="./js/generics.js"></script>
		<script src="./js/session-data.js"></script>
		<!-- Javascript (local) -->
		<script>
			let vue = new Vue({
				el: '#vue-entry',
				data: {
					ajaxLoaded: false,
					errorMessage: '',

					startTime: undefined,
					elapsedTime: undefined,
					agreedTime: undefined,

					studentName: '',

					notesText: ''
				},
				methods: {
					finishSession () {
						const ajaxPackage = {
							elapsedTime: Math.floor(this.elapsedTime / 60000),
							notesText: this.notesText
						};
						http.put('/session/' + getPageUID() + '/complete', ajaxPackage)
							.then(response => {
								console.log(response.data);
							})
							.catch(handleAxiosError)
							.then(errorMessage => this.errorMessage = errorMessage);
					}
				}
			});


			http.get('/session/' + getPageUID())
				.then(response => {
					const sessionData = response.data[0];
					Object.keys(sessionData).forEach(key => vue[key] = sessionData[key]);

					startTiming();

					vue.ajaxLoaded = true;
				})
				.catch(handleAxiosError)
				.then(errorMessage => vue.errorMessage = errorMessage);

			const format_sec = (seconds) => {
				const decimalPlaces = 0;
				const sThisMin = (seconds % 60).toFixed(decimalPlaces);
				return sThisMin < 10 ? '0' + sThisMin : sThisMin;
			};
			const format_min = (minutes) => minutes < 10 ? '0' + minutes : minutes;
			const formatTime = (seconds, minutes) => format_min(minutes) + ':' + format_sec(seconds);

			const buildElapsedTime = (ms) => formatTime(ms / 1000, Math.floor(ms / 60000));

			function startTiming () {
				vue.startTime = performance.now();
				vue.elapsedTime = 0;
				const framesPerSecond = 30;
				const timerUpdateInterval = 1000 / framesPerSecond; // milliseconds
				window.setInterval(() => {
					vue.elapsedTime = performance.now() - vue.startTime;
				}, timerUpdateInterval);
			}

		</script>
	</body>
</html>
