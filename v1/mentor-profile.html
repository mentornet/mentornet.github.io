<html>
	<head>
		<!-- <HEAD> TEMPLATE -->
		<!-- Meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

		<!-- CSS tags. nb: files relative to ./nav-redesign, not ./ -->
    <link href="./vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./vendor/font-awesome/css/font-awesome.min.css">
		<style>
			a:hover {
				text-decoration: none;
			}
		</style>

		<!-- END TEMPLATE -->

		<title>Mentor Net - Mentor Profile</title>
	</head>
	<body class="text-center">

		<!-- Page Title -->
		<header class="container mt-3 mb-3">
			<h4 class="row">
				<span class="col-6">Mentor Net</span>
				<small class="text-muted col mt-1"> Mentor Profile </small>
			</h4>
		</header>

		<!-- Vue Entry -->
		<div id="vue-entry">
			<!-- Site Nav -->
			<nav class="mb-1 container py-1">
				<div class="row">
					<div class="col">
					<a href="mentor-list.html" class="btn btn-sm btn-outline-info">
						<i class="fa fa-users"></i><br>Mentors
					</a>
					</div>
					<div class="col">
					<a href="my-profile.html" class="btn btn-sm btn-outline-info">
						<i class="fa fa-user"></i><br>Profile
					</a>
					</div>
					<div class="col">
						<a href="sessions.html" class="btn btn-sm btn-outline-info">
							<i class="fa fa-globe"></i><br>Sessions
						</a>
					</div>
				</div></nav>

			<div class="bg-dark text-light py-3 container"
				style="display:none" v-show="receivedMentorInfo">

				<div class="row my-1">
					<h6 class="col my-1 text-muted">NAME</h6>
					<p class="col mb-1">{{ mentor.name }}</p>
				</div>

				<div class="row my-1 mb-2">
					<h6 class="col my-1 text-muted">SUBJECT{{ mentor.skills.length > 1 ? 'S' : '' }}</h6>
					<div class="col">
						<p 
							v-for="(subject,index) in mentor.skills"
							class="mb-1">{{ subject.slice(0,1).toUpperCase() + subject.slice(1) }}</p>
					</div>
				</div>

				<!-- Forms to request / cancel booking etc. goes here -->
				<!-- These are contingent on booking status given by server (i.e.: v-show) -->
				<div class="mb-1">
					<div v-show="uiState === uiStates.cannotRequest && data.sessions.current !== -1">
						<div class="col pt-1">
							<p class="small mb-2">You've already requested a session.</p>
							<a class="btn btn-primary btn-sm w-100" href="sessions.html">Review It Here</a>
						</div>
					</div>

					<div class="row" v-show="uiState === uiStates.canRequest">
						<div class="col pt-1">
							<button
								@click="setUIState(uiStates.enteringMinutes)"
								class="btn w-100 btn-primary">Connect</button>
						</div>
					</div>

					<div v-show="uiState === uiStates.enteringMinutes">
						<form class="col pt-1 input-group mb-0" action="javascript:void(0);"
								@submit="setUIState(uiStates.requested)">
							<span class="px-3 pt-1">For</span>
							<input v-model="agreedTime" type="tel" class="form-control text-center" required/>
							<span class="px-3 pt-1">minutes</span>
							<button
								type="submit"
								class="btn btn-sm btn-primary px-3">Go</button>
						</form>
					</div>

					<div class="container" v-show="uiState === uiStates.requested">
						<div class="col pt-1">
							<p class="mb-0 text-muted small">STEP 1</p>
							<p class="mb-0">
								Send <span class="text-warning">${{calculatedFee}}</span> to our
								<span class="text-warning">PayID: 0450797678</span>
							</p>

							<p class="mb-0 text-muted mt-3 small">STEP 2</p>
							<p class="mb-0">We verify your payment</p>

							<p class="mb-0 text-muted mt-3 small">STEP 3</p>
							<p class="mb-0">Your mentor will meet with you for {{agreedTime}} minutes</p>

							<p class="mb-0 text-muted mt-3 small">CANCEL ANYTIME</p>
							<p class="mb-0">Review your booking <a href="sessions.html">here</a></p>
						</div>
					</div>
				</div>

			</div>

			<div v-else class="my-5">
				<i class="fa fa-spinner fa-pulse"></i>
				<p>Loading...</p>
			</div>

		</div>

		<!-- Footer -->
		<footer class="mt-3">
			<p class="mt-0 text-muted">Got a question? Get in touch:</p>
			<h4 class="row mx-auto w-50">
				<a href="mailto:tom@joinmentornet.me" class="col">
					<i class="fa fa-envelope"></i>
					<p class="h6 mt-2">Email</p>
				</a>

				<a href="tel:0450797678" class="col">
					<i class="fa fa-phone"></i>
					<p class="h6 mt-2">Phone</p>
				</a>
			</h4>
		</footer>

		<!-- Javascript (global) -->
		<script src="https://cdn.jsdelivr.net/npm/vue"></script>
		<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

		<script src="./js/generics.js"></script>
		<script src="./js/session-data.js"></script>
		<!-- Javascript (local) -->
		<script>
			if (!hasSessionData()) reauthAndReturn();

			let vue = new Vue({
				el: '#vue-entry',
				data: {
					agreedTime: 60,

					mentor: {
						name: '',
						skills: []
					},

					uiStates: {
						cannotRequest: -1,
						canRequest: 0,
						enteringMinutes: 1,
						requested: () => {
							vue.requestSession();
							return 2;
						}
					},

					uiState: -1
				},
				computed: {
					receivedMentorInfo () {
						return this.mentor.name !== '';
					},
					userHasSession () {
						return data.sessions ? true : false;
					},
					calculatedFee () {
						return this.agreedTime * 0.5;
					}
				},
				methods: {
					setUIState (state) {
						if (typeof state === 'function') state();
						this.uiState = state;
					},
					requestSession () {
						const ajaxPackage = {
							studentUID: data.uid,
							mentorUID: getPageUID(),
							agreedTime: this.agreedTime
						}; 

						http.post('/session', ajaxPackage)
							.then(updatedUserResponse => {
								// Server has validated our account, credit balance, and mentor's account
								this.uiState = this.uiStates.requested;

								buildSessionData(updatedUserResponse.data);

								if (data.sessions.current !== -1) {
									this.uiState = this.uiStates.requested;
								}
							})
							.catch(handleAxiosError);
					},
					cancelSession () {
						if (data.sessions.current) {
							http.delete('/session/' + data.sessions.current + '/cancel')
								.then(updatedUserResponse => {
									buildSessionData(updatedUserResponse.data);
									this.uiState = this.uiStates.canRequest;
								})
								.catch(handleAxiosError);
						}
					},
					cancelOtherSession () {
						if (data.sessions.current) {
							http.delete('/session/' + data.sessions.current + '/cancel')
								.then(updatedUserResponse => {
									buildSessionData(updatedUserResponse.data);
									this.uiState = this.uiStates.canRequest;
								})
								.catch(handleAxiosError);
						}
					}
				}
			});

			http.get('/user/' + getPageUID())
				.then(response => {
					vue.mentor = response.data[0];

					if (data.sessions.current === -1)
						vue.uiState = vue.uiStates.canRequest;

					document.title = `Mentor Net - ${vue.mentor.name}'s Profile`;
				})
				.catch(handleAxiosError);
		</script>
	</body>
</html>
