<!DOCTYPE html>
<html>
	<head>
		<!-- <HEAD> TEMPLATE -->
		<!-- Meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

		<!-- CSS tags. nb: files relative to ./nav-redesign, not ./ -->
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
    <link rel="stylesheet" href="./vendor/font-awesome/css/font-awesome.min.css">
		</style>

		<!-- END TEMPLATE -->

		<title>Mentor Net</title>
	</head>
	<body>

		<header class="container pt-2 pb-0 bg-dark text-light">
			<h4 class="row mb-0">
				<a href="search.html" class="col-6 px-2 text-light">Mentor Net</a>
				<small class="text-right col px-2 mt-1">Book a Session</small>
			</h4>
		</header>

		<nav class="container pt-2 pb-0 bg-dark">
			<div class="row">
				<div class="col-6 px-2">
					<a href="search.html" class="btn btn-sm btn-outline-warning w-100">
						<i class="fa fa-fw fa-search"></i> Search
					</a>
				</div>
				<div class="col-6 px-2">
					<a href="profile.html" class="btn btn-sm btn-outline-warning w-100">
						<i class="fa fa-fw fa-user"></i> Profile
					</a>
				</div>
			</div>
		</nav>

		<div id="vue-entry" class="container">

			<div class="row bg-dark sticky-top text-light justify-content-center py-2 px-2">
				<div v-show="state === states.canRequest" class="col-12 px-0">
					<button class="btn btn-primary btn-sm w-100"
						@click="setState(states.enteringMinutes)">
						Book Now
					</button>
				</div>

				<div v-show="state === states.enteringMinutes" class="col">
					<form class="row" action="javascript:void(0);"
							@submit="requestSession(); setState(states.hasRequested)">

						<div class="col-6 input-group pl-0 pr-2">
							<span class="pt-1">For</span>
							<input v-model="agreedTime" type="tel" size="2" pattern="\d+" class="mx-1 form-control-sm form-control text-center" required/>
							<span class="pt-1">minutes</span>
						</div>
						<div class="col-6 pl-2 pr-0">
							<button
								type="submit"
								class="btn btn-sm btn-primary w-100">Go</button>
						</div>
				</div>

				<div v-show="state === states.hasRequested" class="col text-center">
					Done
				</div>
			</div>

			<div class="py-2">
				Here is where the info about the mentor would go. We should note their
				name, what they can mentor, and then data that validates to students their
				credibility as a mentor:
				<ul>
					<li>Average rating</li>
					<li>How long they've been mentoring / how many sessions they've taken</li>
					<li>Credentials (e.g.: grades, degrees)</li>
					<li>Written feedback e.g.: "Helped me get a HD!"</li>
					<li>Social media (needs considering)</li>
				</ul>
			</div>

		</div>

		<!-- Javascript (global) -->
		<script src="https://cdn.jsdelivr.net/npm/vue"></script>
		<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
		<script src="./js/generics.js"></script>
		<script src="./js/fuzzysearch.js"></script>
		<script src="./js/session-data.js"></script>

		<!-- Javascript (local) -->
		<script>
			let pageData = {
				agreedTime: 60,

				mentor: {
					name: '',
					skills: [],
					// TODO:
					rate: 30 // $ / hr
				},

				states: {
					canRequest: 0,
					enteringMinutes: 1,
					hasRequested: 2
				},

				state: 0
			};

			let vue = new Vue({
				el: '#vue-entry',
				data: pageData,
				methods: {
					setState (state) {
						this.state = state;
					},
					requestSession () {
						const ajaxPackage = {
							studentUID: sessionManager.getDataKey('uid'),
							mentorUID: getPageUID(),
							agreedTime: this.agreedTime
						}; 

						http.post('/session', ajaxPackage)
							.then(updatedUserResponse => {
								// Server has validated our account, credit balance, and mentor's account
								this.uiState = this.uiStates.requested;

								sessionManager.buildDataFromModel(updatedUserResponse.data);

								if (sessionManager.getDataKey('currentSession') !== -1) {
									this.state = this.states.hasRequested;
								}
							})
							.catch(handleAxiosError);
					}
				}
			});

			// TODO: handle loading indicator while we're fetching mentor data
			http.get('/user/' + getPageUID())
				.then(response => {
					// TODO: edge cases (e.g.: what if we've already requested a session?)
					vue.mentor = response.data[0];

					// Nice touch
					document.title = `Mentor Net | Book a session with ${vue.mentor.name}`;
				}).catch(error => {
					// TODO: show user the error on the page 
					handleAxiosError(error);
				});
		</script>

	</body>
</html>
