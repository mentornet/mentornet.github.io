<!DOCTYPE html>
<html>
	<head>
		<!-- <HEAD> TEMPLATE -->
		<!-- Meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

		<!-- CSS tags. nb: files relative to ./nav-redesign, not ./ -->
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
    <link rel="stylesheet" href="./vendor/font-awesome/css/font-awesome.min.css">

		<!-- END TEMPLATE -->

		<title>Mentor Net</title>
	</head>
	<body id="top">

		<header class="container pt-2 pb-0 bg-dark text-light">
			<h4 class="row mb-0">
				<a href="search.html" class="col-6 px-2 text-light">Mentor Net</a>
				<small class="text-right col px-2 mt-1">Your Profile</small>
			</h4>
		</header>

		<nav class="container pt-2 pb-2 bg-dark">
			<div class="row">
				<div class="col-6 px-2">
					<a href="search.html" class="btn btn-sm btn-outline-warning w-100">
						<i class="fa fa-fw fa-search"></i> Learn
					</a>
				</div>
				<div class="col-6 px-2">
					<span class="btn btn-sm btn-warning w-100">
						<i class="fa fa-fw fa-user"></i> Profile
					</span>
				</div>
			</div>
		</nav>

		<div id="vue-entry" class="container" style="display: none" v-show="1">

			<div class="py-2" v-if="comingSessions.length">
				<small class="text-muted border-bottom" id="sessions">COMING SESSIONS</small>

				<a href="#" class="row pt-2" v-for="session in comingSessions">
					<div class="col-3"> {{ session.date }} </div>
					<div class="col-9 text-right"> {{ session.mentorName }} </div>
				</a>

			</div>

			<div class="py-2" v-if="pastSessions.length">
				<small class="text-muted border-bottom" id="sessions">COMING SESSIONS</small>

				<a href="#" class="row pt-2" v-for="session in pastSessions">
					<div class="col-3"> {{ session.date }} </div>
					<div class="col-9 text-right"> {{ session.mentorName }} </div>
				</a>

			</div>

			<div id="settings">
				<div class="py-2">
					<div class="row">
						<div class="col-6" style="height: 26px !important;">
							<small class="text-muted border-bottom">PROFILE SETTINGS</small>
						</div>
						<div class="col-3 px-2" v-show="hasChanges">
							<button
								:disabled="ajaxLoading"
								@click="saveChanges()" class="btn btn-sm btn-outline-success py-0 w-100">

								<i class="fa fa-fw fa-check" v-show="!ajaxLoading"></i> 
								<i class="fa fa-fw fa-pulse fa-spinner" v-show="ajaxLoading"></i> 

							</button>
						</div>
						<div class="col-3 px-2" v-show="hasChanges">
							<button
								:disabled="ajaxLoading"
								@click="discardChanges()" class="btn btn-sm btn-outline-danger py-0 w-100">
								<i class="fa fa-fw fa-times"></i> 
							</button>
						</div>
					</div>

					<div class="row pt-2" v-show="errorMessage.length > 0">
						<p class="small mb-0 text-center col-12 py-2 bg-danger text-light">
							{{ errorMessage }}
						</p>
					</div>

					<div class="row pt-2">
						<div class="col-3 d-flex flex-column align-items-start justify-content-center">
							Email
						</div>
						<div class="col-9 input-group">
							<input type="text" class="form-control form-control-sm"
								:disabled="ajaxLoading"
								v-model="editedProfile.email" />
						</div>
					</div>

					<div class="row pt-2">
						<div class="col-3 d-flex flex-column align-items-start justify-content-center">
							Name
						</div>
						<div class="col-9 input-group">
							<input type="text" class="form-control form-control-sm"
								:disabled="ajaxLoading"
								v-model="editedProfile.name" />
						</div>
					</div>

					<div class="row pt-2">
						<div class="col-3 d-flex flex-column align-items-start justify-content-center">
							Ph No.
						</div>
						<div class="col-9 input-group">
							<input type="text" class="form-control form-control-sm"
								:disabled="ajaxLoading"
								v-model="editedProfile.phone" />
						</div>
					</div>

					<div class="row pt-2" v-if="hasPayID">
						<div class="col-3 d-flex flex-column align-items-start justify-content-center">PayID</div>
						<div class="col-9 input-group">
							<input type="text" class="form-control form-control-sm"
								:disabled="ajaxLoading"
								v-model="editedProfile.payid" />
						</div>
					</div>
					<div v-if="!hasPayID">
						<div class="row pt-2">
							<div class="col-3 d-flex flex-column align-items-start justify-content-center">BSB</div>
							<div class="col-9 input-group">
								<!-- TODO: configure to only allow valid BSBs -->
								<input type="text" class="form-control form-control-sm"
									:disabled="ajaxLoading"
									v-model="editedProfile.bsb" />
							</div>
						</div>
						<div class="row pt-2">
							<div class="col-4 d-flex flex-column align-items-start justify-content-center">Acc No.</div>
							<div class="col-8 input-group">
								<!-- TODO: configure to only allow valid account numbers -->
								<input type="text" class="form-control form-control-sm"
									:disabled="ajaxLoading"
									v-model="editedProfile.accountNumber" />
							</div>
						</div>
					</div>


				</div>

			</div>

		</div>

		<!-- Javascript (global) -->
		<script src="https://cdn.jsdelivr.net/npm/vue"></script>
		<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
		<script src="./js/generics.js"></script>
		<script src="./js/session-data.js"></script>

		<!-- Javascript (local) -->
		<script>
			const copy = (obj) => Object.assign({}, obj);
			const initialUserData = sessionManager.getDataSubset(
					'uid', 'email', 'name', 'phone', 'payid', 'bsb', 'accountNumber'
			);

			let pageData = {
				comingSessions: [],
				pastSessions: [],

				profile: initialUserData,
				editedProfile: copy(initialUserData),

				ajaxLoading: false,
				errorMessage: ''
			};

			let vue = new Vue({
				el: '#vue-entry',
				data: pageData,
				computed: {
					hasSessions () {
						return this.comingSessions.length || this.pastSessions.length;
					},
					hasChanges () {
						const profileValues = Object.values(this.profile);
						const editedValues  = Object.values(this.editedProfile);
						const equivalentValues = profileValues.map((x, i) => x === editedValues[i]);
						const allEquivalent = equivalentValues.reduce((a,b) => a && b, true);
						return !allEquivalent;
					},
					hasPayID () {
						return this.profile.payid && this.profile.payid.length > 0 || false;
					}
				},
				methods: {
					saveChanges () {
						this.ajaxLoading = true;

						const ajaxPackage = this.editedProfile;

						http.put('/user', ajaxPackage)
							.then(response => {
								sessionManager.setDataFromModel(response.data);
								this.profile = response.data;
								this.editedProfile = copy(response.data);
								this.ajaxLoading = false;
							})
							.catch(error => {
								handleAxiosError(error);
								this.showError('Server error: ' + error);
								this.ajaxLoading = false;
								this.discardChanges();
							})
					},
					discardChanges () {
						this.editedProfile = copy(this.profile);
					},

					showError (errorMessage) {
						this.errorMessage = errorMessage;
						setTimeout(() => this.errorMessage = '', 5000);
					}
				},
				mounted () {
					// TODO: check if session data --> if not, boot to login
				}
			});
		</script>

	</body>
</html>
